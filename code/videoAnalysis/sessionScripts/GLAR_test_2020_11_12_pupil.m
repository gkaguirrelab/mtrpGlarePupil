%% GLAR_test_2020_11_17_pupil
%
% The video analysis pre-processing pipeline for an LDOG session.
%
% To define mask bounds, use:
%{
	glintFrameMask = defineCropMask('pupil_L+S_01.mov','startFrame',10)
	pupilFrameMask = defineCropMask('pupil_L+S_01.mov','startFrame',10)
%}
% For the glint, put a tight box around the glint. For the pupil, define a
% mask area that safely contains the pupil at its most dilated.



%% Session parameters

% Subject and session params.
pathParams.Subject = 'GLAR_test';
pathParams.Date = '2020-11-17';
pathParams.Session = 'session_1';

% The names of the videos to process
videoNameStems = {...
    'trial_01',... 
    'trial_02',...
    'trial_03',...
    'trial_04',...
    'trial_05',...
    'trial_06',...
    'trial_07',...
    'trial_08',...
    'trial_09',...
    'trial_10',...
    'trial_11',...
    'trial_12',...
    'trial_13',...
    'trial_14',... 
    'trial_15'
    };

% % Stimulus properties
% sets = {[1 7],[2 8],[3 9],[4 10],[5 11], [6, 12]};
% labels = {'pupil_LightFlux_1-6Hz_RightEyeStim','pupil_RodMel_1-6Hz_RightEyeStim',...
%     'pupil_LplusS_1-6Hz_RightEyeStim', 'pupil_LightFlux_1-6Hz_LeftEyeStim',...
%     'pupil_RodMel_1-6Hz_LeftEyeStim', 'pupil_LplusS_1-6Hz_LeftEyeStim'};
% durations = [504,504,504,504,504,504];
% freqs = [1/6,1/6,1/6,1/6,1/6,1/6];

% % There is only one audio TTL pulse 
% checkCountTRs = [112 112 112 112 112 112 112 112 112 112 112 112];

% Mask bounds
glintFrameMaskSet = {...
    [193   356   240   242], ... 
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   356   240   242], ...
    [193   354   247   244]}; 
pupilFrameMaskSet = {...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142]}; 

% Pupil settings
pupilCircleThreshSet = [0.015,0.015,0.015,0.015,0.015,0.015,0.015,0.015,0.015,0.015,0.015,0.015,0.015,0.015,0.015];
pupilRangeSets = {[24 50],[24 50],[24 50],[24 50],[24 50],[24 50],[24 50],[24 50],[24 50],[24 50],[24 50],[24 50],[24 50],[24 50],[24 50]};
ellipseEccenLBUB = {[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9],[0.2 0.9]};
ellipseAreaLB = [1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000];
ellipseAreaUP = [90000,90000,90000,90000,90000,90000,90000,90000,90000,90000,90000,90000,90000,90000,90000];
pupilGammaCorrection = [0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75,0.75];

% Glint settings
glintPatchRadius = [45,45,45,45,45,45,45,45,45,45,45,45,45,45,45];
glintThreshold = [0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4,0.4];

% Cut settings
candidateThetas = {[pi],[pi],[pi],[pi],[pi],[pi],[pi],[pi],[pi],[pi],[pi],[pi],[pi],[pi],[pi]};
cutErrorThreshold = [0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5];
minRadiusProportion = [0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9];

%% Loop through video name stems get each video and its corresponding masks
vids = [1,2,3,4,5,6,7,8,9,10,11,12];
for ii = vids
    pupilCircleThresh = pupilCircleThreshSet(ii);
    pupilRange = pupilRangeSets{ii};
    videoName = {videoNameStems{ii}};
    glintFrameMask = glintFrameMaskSet{ii};
    pupilFrameMask = pupilFrameMaskSet{ii};
    % Analysis parameters
    % To adjust these parameters for a given session, use the utility:
    %{
        estimatePipelineParamsGUI('','TOME')
    %}
    % And select one of the raw data .mov files.

    sessionKeyValues = {...
        'pupilGammaCorrection', pupilGammaCorrection(ii), ...
        'startFrame',1, ...
        'nFrames', Inf, ...
        'glintFrameMask',glintFrameMask,...
        'glintGammaCorrection',0.75,...
        'glintThreshold',glintThreshold(ii),...
        'pupilFrameMask',pupilFrameMask,...
        'pupilRange',pupilRange,...
        'pupilCircleThresh',pupilCircleThresh,...
        'glintPatchRadius',glintPatchRadius(ii),...
        'candidateThetas',candidateThetas{ii},...
        'cutErrorThreshold',cutErrorThreshold(ii),...
        'radiusDivisions',50,...
        'ellipseTransparentLB',[0,0,ellipseAreaLB(ii), ellipseEccenLBUB{ii}(1), 0],...
        'ellipseTransparentUB',[1280,720,ellipseAreaUP(ii),ellipseEccenLBUB{ii}(2), pi],...
        'minRadiusProportion', minRadiusProportion(ii),...
        };

    % Call the pre-processing pipeline
    mtrpPupilPipeline(pathParams,videoName,sessionKeyValues);
    
end

% %% Call the frequency fitting pipeline
% fourierFitPipeline(pathParams,videoNameStems,sets,labels,durations,freqs);

