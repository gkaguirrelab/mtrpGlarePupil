%% GLAR_briana_2020_12_01_pupil
%
% The video analysis pre-processing pipeline for a MTRP session.
%
% To define mask bounds, use:
%{
	glintFrameMask = defineCropMask('pupil_L+S_01.mov','startFrame',10)
	pupilFrameMask = defineCropMask('pupil_L+S_01.mov','startFrame',10)
%}
% For the glint, put a tight box around the glint. For the pupil, define a
% mask area that safely contains the pupil at its most dilated.



%% Session parameters

% Subject and session params.
pathParams.Subject = 'GLAR_briana';
pathParams.Date = '2020-12-01';
pathParams.Session = 'session_1';

% The names of the videos to process
videoNameStems = {...
    'trial_01',... 
    'trial_02',...
    'trial_03',...
    'trial_04',...
    'trial_05',...
    'trial_06',...
    'trial_07',...
    'trial_08',...
    'trial_09',...
    'trial_10',...
    'trial_11',...
    'trial_12',...
    'trial_13',...
    'trial_14',... 
    'trial_15'
    };

% Mask bounds
glintFrameMaskSet = {...
    [97   307   332   283], ... 
    [66   287   355   285], ...
    [71   293   307   235], ...
    [56   288   301   238], ...
    [65   290   304   238], ...
    [68   294   305   243], ...
    [63   284   302   238], ...
    [67   288   296   240], ...
    [61   295   293   234], ...
    [67   279   297   228], ...
    [64   282   294   228], ...
    [56   276   304   247], ...
    [57   279   304   251], ...
    [62   276   295   241], ...
    [53   264   300   246]}; 
pupilFrameMaskSet = {...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142], ...
    [154   404   233   142]}; 

% Pupil settings
pupilCircleThreshSet = 0.015;
pupilRangeSets = [35 50];
ellipseEccenLBUB = [0.2 0.9];
ellipseAreaLB = 1000;
ellipseAreaUP = 90000;
pupilGammaCorrection = 0.75;

% Glint settings
glintPatchRadius = 45;
glintThreshold = 0.4;

% Control stage values (after the 3th before the 6th stage)
% Cut settings: 0 for buttom cut, pi/2 for right, pi for top, 3*pi/4 for
% left
candidateThetas = pi;
minRadiusProportion = 0.9;
cutErrorThreshold = 0.5;
%% Loop through video name stems get each video and its corresponding masks
% vids = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
vids = 1:15;
for ii = vids
    pupilCircleThresh = pupilCircleThreshSet;
    pupilRange = pupilRangeSets;
    videoName = {videoNameStems{ii}};
    glintFrameMask = glintFrameMaskSet{ii};
    pupilFrameMask = pupilFrameMaskSet{ii};
    % Analysis parameters
    % To adjust these parameters for a given session, use the utility:
    %{
        estimatePipelineParamsGUI('','TOME')
    %}
    % And select one of the raw data .mov files.

    sessionKeyValues = {...
        'pupilGammaCorrection', pupilGammaCorrection, ...
        'startFrame',1, ...
        'nFrames', Inf, ...
        'glintFrameMask',glintFrameMask,...
        'glintGammaCorrection',0.75,...
        'glintThreshold',glintThreshold,...
        'pupilFrameMask',pupilFrameMask,...
        'pupilRange',pupilRange,...
        'pupilCircleThresh',pupilCircleThresh,...
        'glintPatchRadius',glintPatchRadius,...
        'candidateThetas',candidateThetas,...
        'cutErrorThreshold',cutErrorThreshold,...
        'radiusDivisions',50,...
        'ellipseTransparentLB',[0,0,ellipseAreaLB, ellipseEccenLBUB(1), 0],...
        'ellipseTransparentUB',[1280,720,ellipseAreaUP,ellipseEccenLBUB(2), pi],...
        'minRadiusProportion', minRadiusProportion,...
        };

    % Call the pre-processing pipeline
    mtrpPupilPipeline(pathParams,videoName,sessionKeyValues);
    
end

